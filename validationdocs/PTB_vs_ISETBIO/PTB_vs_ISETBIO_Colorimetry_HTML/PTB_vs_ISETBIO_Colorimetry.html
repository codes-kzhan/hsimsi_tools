
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>PTB_vs_ISETBIO_Colorimetry</title><meta name="generator" content="MATLAB 8.3"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2014-09-22"><meta name="DC.source" content="PTB_vs_ISETBIO_Colorimetry.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">Skeleton validation script</a></li><li><a href="#4">Initialize return params</a></li><li><a href="#5">SETUP</a></li><li><a href="#6">XYZ-related colorimetry</a></li><li><a href="#7">xyY</a></li><li><a href="#8">CIE uv chromaticity</a></li><li><a href="#9">CIELUV</a></li><li><a href="#10">CIELAB</a></li><li><a href="#11">sRGB</a></li><li><a href="#12">Quanta/Energy</a></li><li><a href="#13">CIE daylights</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> PTB_vs_ISETBIO_Colorimetry(runParams)
<span class="comment">%</span>
<span class="comment">%  Validate ISETBIO-based colorimetric computations by comparing to PTB-based colorimetric computations.</span>
<span class="comment">%</span>

    <span class="comment">% Call the validation script</span>
    [validationReport, validationFailedFlag, validationDataToSave] = validationScript(runParams);

    <span class="comment">% Update the parent @UnitTest object</span>
    UnitTest.updateParentUnitTestObject(validationReport, validationFailedFlag, validationDataToSave, runParams);
<span class="keyword">end</span>
</pre><h2>Skeleton validation script<a name="2"></a></h2><pre class="codeinput"><span class="keyword">function</span> [validationReport, validationFailedFlag, validationDataToSave] = validationScript(runParams)
</pre><h2>Initialize return params<a name="4"></a></h2><pre class="codeinput">    validationReport = <span class="string">''</span>;
    validationFailedFlag = false;
    validationDataToSave = struct();
</pre><h2>SETUP<a name="5"></a></h2><pre class="codeinput">    isetbioPath = fileparts(which(<span class="string">'colorTransformMatrix'</span>));
    curDir = pwd;
    tolerance = 1e-10;
</pre><h2>XYZ-related colorimetry<a name="6"></a></h2><pre class="codeinput">    message = sprintf(<span class="string">'\n\t\t***** Basic XYZ *****'</span>);
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);

    testXYZs = [[1 2 1]' [2 1 0.5]' [1 1 1]' [0.6 2.3 4]'];
    ptbxyYs = XYZToxyY(testXYZs);
    ptbxys  = ptbxyYs(1:2,:);
    isetxys = chromaticity(testXYZs')';

    <span class="keyword">if</span> (any(abs(ptbxys-isetxys) &gt; tolerance))
        message = sprintf(<span class="string">'\n\t\tPTB-ISET DIFFERENCE for XYZ to xy (tolerance: %g)'</span>, tolerance);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB-ISET AGREE for XYZ to xy (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>

    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.testXYZs = testXYZs;
    validationDataToSave.ptbxys = ptbxys;
    validationDataToSave.isetxys = isetxys;
</pre><h2>xyY<a name="7"></a></h2><pre class="codeinput">    ptbXYZs = xyYToXYZ(ptbxyYs);
    <span class="keyword">if</span> (any(abs(testXYZs-ptbXYZs) &gt; tolerance))
        message = sprintf(<span class="string">'\n\t\tPTB FAILS XYZ to xyY to XYZ (tolerance: %g)'</span>, tolerance);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB PASSES XYZ to xyY to XYZ (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>

    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.ptbXYZs = ptbXYZs;

    isetXYZs = xyy2xyz(ptbxyYs')';
    <span class="keyword">if</span> (any(abs(testXYZs-isetXYZs) &gt; tolerance))
        message = sprintf(<span class="string">'\n\t\tPTB-ISET DIFFERENCE for xyY to XYZ (tolerance: %g)'</span>, tolerance);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB-ISET AGREE for xyY to XYZ (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>

    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.isetXYZs = isetXYZs;
</pre><h2>CIE uv chromaticity<a name="8"></a></h2><pre class="codeinput">    ptbuvYs = XYZTouvY(testXYZs);
    ptbuvs = ptbuvYs(1:2,:);
    [isetus,isetvs] = xyz2uv(testXYZs');
    isetuvs = [isetus' ; isetvs'];
    <span class="keyword">if</span> (any(abs(ptbuvs-isetuvs) &gt; tolerance))
        message = sprintf(<span class="string">'\n\t\tPTB-ISET DIFFERENCE for XYZ to uv (tolerance: %g)'</span>, tolerance);
        message = sprintf(<span class="string">'%s\n\t\t\tI think this is because ISET implements an obsolete version of the standard'</span>, message);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB-ISET AGREE for XYZ to uv (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>

    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.ptbuvs = ptbuvs;
    validationDataToSave.isetuvs = isetuvs;
</pre><h2>CIELUV<a name="9"></a></h2><pre class="codeinput">    whiteXYZ = [3,4,3]';
    ptbLuvs = XYZToLuv(testXYZs,whiteXYZ);
    isetLuvs = xyz2luv(testXYZs',whiteXYZ')';
    <span class="keyword">if</span> (any(abs(ptbLuvs-isetLuvs) &gt; tolerance))
        message = sprintf(<span class="string">'\n\t\tPTB-ISET DIFFERENCE for XYZ to Luv (tolerance: %g)'</span>, tolerance);
        message = sprintf(<span class="string">'%s\n\t\t\tPresumably because the uv transformation differs.'</span>, message);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB-ISET AGREE for XYZ to Luv (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>

    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.whiteXYZ = whiteXYZ;
    validationDataToSave.ptbLuvs = ptbLuvs;
    validationDataToSave.isetLuvs = isetLuvs;
</pre><h2>CIELAB<a name="10"></a></h2><pre class="codeinput">    whiteXYZ = [3,4,3]';
    ptbLabs = XYZToLab(testXYZs,whiteXYZ);
    cd(isetbioPath);
    isetLabs = xyz2lab(testXYZs',whiteXYZ')';
    cd(curDir);
    <span class="keyword">if</span> (any(abs(ptbLabs-isetLabs) &gt; tolerance))
        message = sprintf(<span class="string">'\n\t\tPTB-ISET DIFFERENCE for XYZ to Lab (tolerance: %g)'</span>, tolerance);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB-ISET AGREE for XYZ to Lab (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>
    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.ptbLabs  = ptbLabs;
    validationDataToSave.isetLabs = isetLabs;

    ptbXYZCheck = LabToXYZ(ptbLabs,whiteXYZ);
    isetXYZCheck = lab2xyz(isetLabs',whiteXYZ')';
    <span class="keyword">if</span> (any(abs(testXYZs-ptbXYZCheck) &gt; tolerance ))
        message = sprintf(<span class="string">'\n\t\tPTB FAILS XYZ to Lab to XYZ (tolerance: %g)'</span>, tolerance);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB PASSES XYZ to Lab to XYZ (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>
    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.ptbXYZCheck  = ptbXYZCheck;

    <span class="keyword">if</span> (any(abs(testXYZs-isetXYZCheck) &gt; tolerance))
        message = sprintf(<span class="string">'\n\t\tISET FAILS XYZ to Lab to XYZ (tolerance: %g)'</span>, tolerance);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tISET PASSES XYZ to Lab to XYZ (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>
    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.isetXYZCheck  = isetXYZCheck;
</pre><h2>sRGB<a name="11"></a></h2><p>The iset routines seem to use a matrix that is 1/100 of the standard definition.  Or, at least, 1/100 of what the PTB routines use.  To account for this, I multiply XYZ values by 100 before passing them to the iset routines.</p><p>The iset routines take an exponent argument for the sRGB gamma transform. At <a href="http://www.w3.org/Graphics/Color/sRGB">http://www.w3.org/Graphics/Color/sRGB</a> this is specified as 2.4.  The iset routine xyz2srgb uses 2.2, with a comment that an update at www.srgb.com changed this from 2.4 to 2.2.  I think this is wrong, though.  The text I can find on the web says that the 2.4 exponent, plus the linear initial region, is designed to approximate a gamma of 2.2. That is, you want 2.4 in the formulae to approximate the 2.2 industry standard gamma.  Site www.srgb.com now appears gone, by the way, but all the other sites I find seem to be the same in this regard.</p><p>Also note that if you change the exponent in the iset sRGB formulae, you also should probably change the cutoff used at the low-end, where the sRGB standard special cases the functional form of the gamma curve.  Here the test is set for 2.4.</p><p>Finally,the default gamma used by iset lrgb2srgb and by xzy2srgb currently differ, so you really want to be careful using these.  The inverse routine srgb2lrgb doesn't allow passing of the exponent, and it is hard coded as 2.4.  This causes a failure of the iset sRGB gamma routines to self-invert for gamma other than 2.4, and with their defaults.</p><p>One other convention difference is that the PTB routine rounds to integers for the settings, while the iset routine leaves the rounding up to the caller.</p><pre class="codeinput">    message = sprintf(<span class="string">'\n\n\t\t***** sRGB*****'</span>);
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);

    <span class="comment">% Create some test sRGB values and convert them in the PTB framework</span>
    ptbSRGBs = [[188 188 188]' [124 218 89]' [255 149 203]' [255 3 203]'];
    ptbSRGBPrimary = SRGBGammaUncorrect(ptbSRGBs);
    ptbXYZs = SRGBPrimaryToXYZ(ptbSRGBPrimary);

    <span class="comment">% The ISET form takes the frame buffer values in the [0,1] regime</span>
    isetSRGBs = ptbSRGBs/255;
    isetSRGBs = XW2RGBFormat(isetSRGBs',4,1);
    isetXYZ   = srgb2xyz(isetSRGBs);
    isetXYZs  = RGB2XWFormat(isetXYZ)';

    <span class="keyword">if</span> (any(abs(isetXYZs-ptbXYZs) &gt; tolerance))
        d = isetXYZs - ptbXYZs;
        message = sprintf(<span class="string">'\n\t\tPTB-ISET DIFFERENCE for XYZ to sRGB: %f (tolerance: %g)'</span>,max(abs(d(:))), tolerance);
        d = d ./ptbXYZs;
        message = sprintf(<span class="string">'%s\n\t\tPTB-ISET Percent XYZ DIFFERENCE: %f\n'</span>, message, max(abs(d(:))));
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB-ISET AGREE for XYZ to sRGB (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>

    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.isetXYZs = isetXYZs;
    validationDataToSave.ptbXYZs = ptbXYZs;

    <span class="comment">% PTB testing of inversion</span>
    <span class="keyword">if</span> (any(abs(XYZToSRGBPrimary(ptbXYZs)-ptbSRGBPrimary) &gt; tolerance))
        message = sprintf(<span class="string">'\n\t\tPTB FAILS linear sRGB to XYZ to linear sRGB (tolerance: %g)'</span>, tolerance);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB PASSES linear sRGB to XYZ to linear sRGB (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>
    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.ptbSRGBPrimary = ptbSRGBPrimary;


    <span class="keyword">if</span> (any(abs(SRGBGammaCorrect(ptbSRGBPrimary)-ptbSRGBs) &gt; tolerance))
        message = sprintf(<span class="string">'\n\t\tPTB FAILS sRGB to linear sRGB to sRGB (tolerance: %g)'</span>, tolerance);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB PASSES sRGB to linear sRGB to sRGB (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>
    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.ptbSRGBs = ptbSRGBs;


    <span class="comment">% Compare sRGB matrices</span>
    [nil,ptbSRGBMatrix] = XYZToSRGBPrimary([]);
    isetSRGBMatrix = colorTransformMatrix(<span class="string">'xyz2srgb'</span>)';

    <span class="keyword">if</span> (any(abs(ptbSRGBMatrix-isetSRGBMatrix) &gt; tolerance))
        message = sprintf(<span class="string">'\n\t\tPTB-ISET DIFFERENCE for sRGB transform matrix (tolerance: %g)'</span>, tolerance);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB-ISET AGREE for sRGB transform matrix (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>
    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.ptbSRGBMatrix = ptbSRGBMatrix;
    validationDataToSave.isetSRGBMatrix = isetSRGBMatrix;

    <span class="comment">% XYZ -&gt; lRGB</span>
    <span class="comment">% Reformat shape</span>
    ptbXYZsImage = CalFormatToImage(ptbXYZs,1,size(ptbXYZs,2));

    <span class="comment">% ISET convert</span>
    [isetSRGBImage,isetSRGBPrimaryImage] = xyz2srgb(ptbXYZsImage);

    <span class="comment">% Reformat shape</span>
    isetSRGBs = ImageToCalFormat(isetSRGBImage);
    isetSRGBPrimary = ImageToCalFormat(isetSRGBPrimaryImage);

    <span class="keyword">if</span> (any(abs(ptbSRGBPrimary-isetSRGBPrimary) &gt; tolerance))
        d = ptbSRGBPrimary - isetSRGBPrimary;
        message = sprintf(<span class="string">'\n\t\tPTB-ISET DIFFERENCE for XYZ to sRGB: %f (tolerance: %g)'</span>,max(abs(d(:))), tolerance);
        d = d ./isetSRGBPrimary;
        message = sprintf(<span class="string">'%s\n\t\tPTB-ISET Percent RGB DIFFERENCE: %f'</span>, message, max(abs(d(:))));
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB-ISET AGREE for XYZ to linear sRGB (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>
    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.ptbSRGBPrimary = ptbSRGBPrimary;
    validationDataToSave.isetSRGBPrimary = isetSRGBPrimary;


    <span class="comment">% ISET/PTB sRGB comparison in integer gamma corrected space</span>
    <span class="keyword">if</span> (any(abs(round(isetSRGBs*255)-ptbSRGBs) &gt; tolerance))
        message = sprintf(<span class="string">'\n\t\tPTB-ISET DIFFERENCE for XYZ to sRGB (tolerance: %g)'</span>, tolerance);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB-ISET AGREE for XYZ to sRGB (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>
    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.isetSRGBs = isetSRGBs*255;
    validationDataToSave.ptbSRGBs = ptbSRGBs;


    <span class="comment">% lrgb -&gt; srgb -&gt; lrgb in ISET</span>
    isetSRGBPrimaryCheckImage = srgb2lrgb(isetSRGBImage);
    isetSRGBPrimaryCheck = ImageToCalFormat(isetSRGBPrimaryCheckImage);
    <span class="keyword">if</span> (any(abs(isetSRGBPrimaryCheck-isetSRGBPrimary) &gt; 1e-10))
        message = sprintf(<span class="string">'\n\t\tISET FAILS linear sRGB to sRGB to linear sRGB (tolerance: %g)'</span>, tolerance);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tISET PASSES linear sRGB to sRGB to linear sRGB (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>
    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.isetSRGBPrimaryCheck = isetSRGBPrimaryCheck;
    validationDataToSave.isetSRGBPrimary = isetSRGBPrimary;
</pre><h2>Quanta/Energy<a name="12"></a></h2><p>The ISET routines define c and h to more places than the PTB, so the agreement is only good to about 5 significant places.  Seems OK to me.</p><pre class="codeinput">    message = sprintf(<span class="string">'\n\n\t\t***** Energy/Quanta *****'</span>);
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);

    load <span class="string">spd_D65</span>
    spdEnergyTest = spd_D65;
    wlsTest = SToWls(S_D65);
    testPlaces = 5;
    ptbQuanta = EnergyToQuanta(wlsTest,spdEnergyTest);
    isetQuanta = Energy2Quanta(wlsTest,spdEnergyTest);
    toleranceQuanta = (10^-testPlaces)*min(ptbQuanta);
    <span class="keyword">if</span> (any(abs(ptbQuanta-isetQuanta) &gt; toleranceQuanta))
        message = sprintf(<span class="string">'\n\t\tPTB-ISET DIFFERENCE for energy to quanta conversion at %d significant places (tolerance: %g)'</span>,testPlaces, toleranceQuanta);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB-ISET AGREE for energy to quanta conversion to %d significant places (tolerance: %g)'</span>,testPlaces,  toleranceQuanta);
    <span class="keyword">end</span>

    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.ptbQuanta = ptbQuanta;
    validationDataToSave.isetQuanta = isetQuanta;


    <span class="keyword">if</span> (any(abs(QuantaToEnergy(wlsTest,ptbQuanta)-spdEnergyTest) &gt; tolerance))
        message = sprintf(<span class="string">'\n\t\tPTB FAILS energy to quanta to energy (tolerance: %g)'</span>, tolerance);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB PASSES energy to quanta to energy (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>
    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.ptbEnergyFromQuanta = QuantaToEnergy(wlsTest,ptbQuanta);
    validationDataToSave.spdEnergyTest = spdEnergyTest;

    <span class="keyword">if</span> (any(abs(Quanta2Energy(wlsTest,isetQuanta')'- spdEnergyTest) &gt; tolerance))
        message = sprintf(<span class="string">'\n\t\tISET FAILS energy to quanta to energy (tolerance: %g)'</span>, tolerance);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tISET PASSES energy to quanta to energy (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>
    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.isetEnergyFromQuanta = Quanta2Energy(wlsTest,isetQuanta')';
</pre><h2>CIE daylights<a name="13"></a></h2><p>These routines are now running in ISET and everything agrees.</p><pre class="codeinput">    message = sprintf(<span class="string">'\n\n\t\t***** Energy/Quanta *****'</span>);
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);

    load <span class="string">B_cieday</span>
    testWls = SToWls(S_cieday);
    testTemp = 4987;
    ptbDaySpd = GenerateCIEDay(testTemp,B_cieday);
    ptbDaySpd = ptbDaySpd/max(ptbDaySpd(:));

    <span class="comment">% Iset version of normalized daylight</span>
    isetDaySpd = daylight(testWls,testTemp);
    isetDaySpd = isetDaySpd/max(isetDaySpd(:));
    <span class="keyword">if</span> (any(abs(isetDaySpd-ptbDaySpd) &gt; tolerance))
        message = sprintf(<span class="string">'\n\t\tPTB-ISET DIFFERENCE for daylight (tolerance: %g)'</span>, tolerance);
        validationFailedFlag = true;
    <span class="keyword">else</span>
        message = sprintf(<span class="string">'\n\t\tPTB-ISET AGREE for for daylight (tolerance: %g)'</span>, tolerance);
    <span class="keyword">end</span>
    <span class="comment">% update validation report and validationDataToSave struct</span>
    validationReport = sprintf(<span class="string">'%s %s'</span>, validationReport, message);
    validationDataToSave.isetDaySpd = isetDaySpd;
    validationDataToSave.ptbDaySpd  = ptbDaySpd;


    <span class="comment">% Generate plots, if so specified</span>
    <span class="keyword">if</span> (nargin &gt;= 1) &amp;&amp; (isfield(runParams, <span class="string">'generatePlots'</span>)) &amp;&amp; (runParams.generatePlots == true)
        <span class="comment">% Your plotting code goes here.</span>
    <span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><pre class="codeoutput">
 Results for 'PTB_vs_ISETBIO_Colorimetry' probe:
	--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	 validation status      : PASSED
	--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	 validation report      :  
		***** Basic XYZ ***** 
		PTB-ISET AGREE for XYZ to xy (tolerance: 1e-10) 
		PTB PASSES XYZ to xyY to XYZ (tolerance: 1e-10) 
		PTB-ISET AGREE for xyY to XYZ (tolerance: 1e-10) 
		PTB-ISET AGREE for XYZ to uv (tolerance: 1e-10) 
		PTB-ISET AGREE for XYZ to Luv (tolerance: 1e-10) 
		PTB-ISET AGREE for XYZ to Lab (tolerance: 1e-10) 
		PTB PASSES XYZ to Lab to XYZ (tolerance: 1e-10) 
		ISET PASSES XYZ to Lab to XYZ (tolerance: 1e-10) 

		***** sRGB***** 
		PTB-ISET AGREE for XYZ to sRGB (tolerance: 1e-10) 
		PTB PASSES linear sRGB to XYZ to linear sRGB (tolerance: 1e-10) 
		PTB PASSES sRGB to linear sRGB to sRGB (tolerance: 1e-10) 
		PTB-ISET AGREE for sRGB transform matrix (tolerance: 1e-10) 
		PTB-ISET AGREE for XYZ to linear sRGB (tolerance: 1e-10) 
		PTB-ISET AGREE for XYZ to sRGB (tolerance: 1e-10) 
		ISET PASSES linear sRGB to sRGB to linear sRGB (tolerance: 1e-10) 

		***** Energy/Quanta ***** 
		PTB-ISET AGREE for energy to quanta conversion to 5 significant places (tolerance: 9.56086e+14) 
		PTB PASSES energy to quanta to energy (tolerance: 1e-10) 
		ISET PASSES energy to quanta to energy (tolerance: 1e-10) 

		***** Energy/Quanta ***** 
		PTB-ISET AGREE for for daylight (tolerance: 1e-10)
	--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	 validation data saved  : 'testXYZs', 'ptbxys', 'isetxys', 'ptbXYZs', 'isetXYZs', 'ptbuvs', 'isetuvs', 'whiteXYZ', 'ptbLuvs', 'isetLuvs', 'ptbLabs', 'isetLabs', 'ptbXYZCheck', 'isetXYZCheck', 'ptbSRGBPrimary', 'ptbSRGBs', 'ptbSRGBMatrix', 'isetSRGBMatrix', 'isetSRGBPrimary', 'isetSRGBs', 'isetSRGBPrimaryCheck', 'ptbQuanta', 'isetQuanta', 'ptbEnergyFromQuanta', 'spdEnergyTest', 'isetEnergyFromQuanta', 'isetDaySpd', 'ptbDaySpd'
	--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
	 date last run          : 22-Sep-2014 17:08:31
	 matlabVersion          : 8.3.0.532 (R2014a)
	 computer architecture  : MACI64
	 git branch...tracking  : dev...origin/dev of ISETBIO
	
	--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014a</a><br></p></div><!--
##### SOURCE BEGIN #####
function PTB_vs_ISETBIO_Colorimetry(runParams)
%
%  Validate ISETBIO-based colorimetric computations by comparing to PTB-based colorimetric computations.
%

    % Call the validation script
    [validationReport, validationFailedFlag, validationDataToSave] = validationScript(runParams);

    % Update the parent @UnitTest object
    UnitTest.updateParentUnitTestObject(validationReport, validationFailedFlag, validationDataToSave, runParams);
end

%% Skeleton validation script
function [validationReport, validationFailedFlag, validationDataToSave] = validationScript(runParams)

    %% Initialize return params
    validationReport = ''; 
    validationFailedFlag = false; 
    validationDataToSave = struct();
    
    %% SETUP
    isetbioPath = fileparts(which('colorTransformMatrix'));
    curDir = pwd; 
    tolerance = 1e-10;
    
    %% XYZ-related colorimetry
    %
    message = sprintf('\n\t\t***** Basic XYZ *****');
    validationReport = sprintf('%s %s', validationReport, message);
    
    testXYZs = [[1 2 1]' [2 1 0.5]' [1 1 1]' [0.6 2.3 4]'];
    ptbxyYs = XYZToxyY(testXYZs);
    ptbxys  = ptbxyYs(1:2,:);
    isetxys = chromaticity(testXYZs')';
    
    if (any(abs(ptbxys-isetxys) > tolerance))
        message = sprintf('\n\t\tPTB-ISET DIFFERENCE for XYZ to xy (tolerance: %g)', tolerance);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB-ISET AGREE for XYZ to xy (tolerance: %g)', tolerance);
    end
    
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.testXYZs = testXYZs;
    validationDataToSave.ptbxys = ptbxys;
    validationDataToSave.isetxys = isetxys;
    
    %% xyY
    ptbXYZs = xyYToXYZ(ptbxyYs);
    if (any(abs(testXYZs-ptbXYZs) > tolerance))
        message = sprintf('\n\t\tPTB FAILS XYZ to xyY to XYZ (tolerance: %g)', tolerance);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB PASSES XYZ to xyY to XYZ (tolerance: %g)', tolerance);
    end
    
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.ptbXYZs = ptbXYZs;
    
    isetXYZs = xyy2xyz(ptbxyYs')';
    if (any(abs(testXYZs-isetXYZs) > tolerance))
        message = sprintf('\n\t\tPTB-ISET DIFFERENCE for xyY to XYZ (tolerance: %g)', tolerance);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB-ISET AGREE for xyY to XYZ (tolerance: %g)', tolerance);
    end 
    
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.isetXYZs = isetXYZs;

    
    %% CIE uv chromaticity
    ptbuvYs = XYZTouvY(testXYZs);
    ptbuvs = ptbuvYs(1:2,:);
    [isetus,isetvs] = xyz2uv(testXYZs');
    isetuvs = [isetus' ; isetvs'];
    if (any(abs(ptbuvs-isetuvs) > tolerance))
        message = sprintf('\n\t\tPTB-ISET DIFFERENCE for XYZ to uv (tolerance: %g)', tolerance);
        message = sprintf('%s\n\t\t\tI think this is because ISET implements an obsolete version of the standard', message);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB-ISET AGREE for XYZ to uv (tolerance: %g)', tolerance);
    end
    
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.ptbuvs = ptbuvs;
    validationDataToSave.isetuvs = isetuvs;
    
    %% CIELUV
    whiteXYZ = [3,4,3]';
    ptbLuvs = XYZToLuv(testXYZs,whiteXYZ);
    isetLuvs = xyz2luv(testXYZs',whiteXYZ')';
    if (any(abs(ptbLuvs-isetLuvs) > tolerance))
        message = sprintf('\n\t\tPTB-ISET DIFFERENCE for XYZ to Luv (tolerance: %g)', tolerance);
        message = sprintf('%s\n\t\t\tPresumably because the uv transformation differs.', message);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB-ISET AGREE for XYZ to Luv (tolerance: %g)', tolerance);
    end
    
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.whiteXYZ = whiteXYZ;
    validationDataToSave.ptbLuvs = ptbLuvs;
    validationDataToSave.isetLuvs = isetLuvs;
    
    %% CIELAB
    whiteXYZ = [3,4,3]';
    ptbLabs = XYZToLab(testXYZs,whiteXYZ);
    cd(isetbioPath);
    isetLabs = xyz2lab(testXYZs',whiteXYZ')';
    cd(curDir);
    if (any(abs(ptbLabs-isetLabs) > tolerance))
        message = sprintf('\n\t\tPTB-ISET DIFFERENCE for XYZ to Lab (tolerance: %g)', tolerance);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB-ISET AGREE for XYZ to Lab (tolerance: %g)', tolerance);
    end
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.ptbLabs  = ptbLabs;
    validationDataToSave.isetLabs = isetLabs;
    
    ptbXYZCheck = LabToXYZ(ptbLabs,whiteXYZ);
    isetXYZCheck = lab2xyz(isetLabs',whiteXYZ')';
    if (any(abs(testXYZs-ptbXYZCheck) > tolerance ))
        message = sprintf('\n\t\tPTB FAILS XYZ to Lab to XYZ (tolerance: %g)', tolerance);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB PASSES XYZ to Lab to XYZ (tolerance: %g)', tolerance);
    end
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.ptbXYZCheck  = ptbXYZCheck;
    
    if (any(abs(testXYZs-isetXYZCheck) > tolerance))
        message = sprintf('\n\t\tISET FAILS XYZ to Lab to XYZ (tolerance: %g)', tolerance);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tISET PASSES XYZ to Lab to XYZ (tolerance: %g)', tolerance);
    end
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.isetXYZCheck  = isetXYZCheck;

    
    %% sRGB
    %
    % The iset routines seem to use a matrix that is 1/100 of the standard
    % definition.  Or, at least, 1/100 of what the PTB routines use.  To
    % account for this, I multiply XYZ values by 100 before passing them
    % to the iset routines.
    %
    % The iset routines take an exponent argument for the sRGB gamma transform.
    % At http://www.w3.org/Graphics/Color/sRGB this is specified as 2.4.  The
    % iset routine xyz2srgb uses 2.2, with a comment that an update at
    % www.srgb.com changed this from 2.4 to 2.2.  I think this is wrong,
    % though.  The text I can find on the web says that the 2.4 exponent, plus
    % the linear initial region, is designed to approximate a gamma of 2.2.
    % That is, you want 2.4 in the formulae to approximate the 2.2 industry
    % standard gamma.  Site www.srgb.com now appears gone, by the way, but all
    % the other sites I find seem to be the same in this regard.
    % 
    % Also note that if you change the exponent in the iset sRGB formulae, you
    % also should probably change the cutoff used at the low-end, where the
    % sRGB standard special cases the functional form of the gamma curve.  Here
    % the test is set for 2.4.
    %
    % Finally,the default gamma used by iset lrgb2srgb and by xzy2srgb
    % currently differ, so you really want to be careful using these.  The
    % inverse routine srgb2lrgb doesn't allow passing of the exponent, and it
    % is hard coded as 2.4.  This causes a failure of the iset sRGB gamma
    % routines to self-invert for gamma other than 2.4, and with their
    % defaults.
    %
    % One other convention difference is that the PTB routine rounds to
    % integers for the settings, while the iset routine leaves the rounding up
    % to the caller.
    message = sprintf('\n\n\t\t***** sRGB*****');
    validationReport = sprintf('%s %s', validationReport, message);

    % Create some test sRGB values and convert them in the PTB framework
    ptbSRGBs = [[188 188 188]' [124 218 89]' [255 149 203]' [255 3 203]'];
    ptbSRGBPrimary = SRGBGammaUncorrect(ptbSRGBs);
    ptbXYZs = SRGBPrimaryToXYZ(ptbSRGBPrimary);

    % The ISET form takes the frame buffer values in the [0,1] regime
    isetSRGBs = ptbSRGBs/255;
    isetSRGBs = XW2RGBFormat(isetSRGBs',4,1);
    isetXYZ   = srgb2xyz(isetSRGBs);
    isetXYZs  = RGB2XWFormat(isetXYZ)';

    if (any(abs(isetXYZs-ptbXYZs) > tolerance))
        d = isetXYZs - ptbXYZs;
        message = sprintf('\n\t\tPTB-ISET DIFFERENCE for XYZ to sRGB: %f (tolerance: %g)',max(abs(d(:))), tolerance);
        d = d ./ptbXYZs;
        message = sprintf('%s\n\t\tPTB-ISET Percent XYZ DIFFERENCE: %f\n', message, max(abs(d(:))));
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB-ISET AGREE for XYZ to sRGB (tolerance: %g)', tolerance);
    end

    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.isetXYZs = isetXYZs;
    validationDataToSave.ptbXYZs = ptbXYZs;
    
    % PTB testing of inversion
    if (any(abs(XYZToSRGBPrimary(ptbXYZs)-ptbSRGBPrimary) > tolerance))
        message = sprintf('\n\t\tPTB FAILS linear sRGB to XYZ to linear sRGB (tolerance: %g)', tolerance);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB PASSES linear sRGB to XYZ to linear sRGB (tolerance: %g)', tolerance);
    end
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.ptbSRGBPrimary = ptbSRGBPrimary;
    
    
    if (any(abs(SRGBGammaCorrect(ptbSRGBPrimary)-ptbSRGBs) > tolerance))
        message = sprintf('\n\t\tPTB FAILS sRGB to linear sRGB to sRGB (tolerance: %g)', tolerance);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB PASSES sRGB to linear sRGB to sRGB (tolerance: %g)', tolerance);
    end
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.ptbSRGBs = ptbSRGBs;
    
    
    % Compare sRGB matrices
    [nil,ptbSRGBMatrix] = XYZToSRGBPrimary([]);
    isetSRGBMatrix = colorTransformMatrix('xyz2srgb')';

    if (any(abs(ptbSRGBMatrix-isetSRGBMatrix) > tolerance))
        message = sprintf('\n\t\tPTB-ISET DIFFERENCE for sRGB transform matrix (tolerance: %g)', tolerance);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB-ISET AGREE for sRGB transform matrix (tolerance: %g)', tolerance);
    end
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.ptbSRGBMatrix = ptbSRGBMatrix;
    validationDataToSave.isetSRGBMatrix = isetSRGBMatrix;
    
    % XYZ -> lRGB 
    % Reformat shape
    ptbXYZsImage = CalFormatToImage(ptbXYZs,1,size(ptbXYZs,2));

    % ISET convert 
    [isetSRGBImage,isetSRGBPrimaryImage] = xyz2srgb(ptbXYZsImage);

    % Reformat shape
    isetSRGBs = ImageToCalFormat(isetSRGBImage); 
    isetSRGBPrimary = ImageToCalFormat(isetSRGBPrimaryImage);

    if (any(abs(ptbSRGBPrimary-isetSRGBPrimary) > tolerance))
        d = ptbSRGBPrimary - isetSRGBPrimary;
        message = sprintf('\n\t\tPTB-ISET DIFFERENCE for XYZ to sRGB: %f (tolerance: %g)',max(abs(d(:))), tolerance);
        d = d ./isetSRGBPrimary;
        message = sprintf('%s\n\t\tPTB-ISET Percent RGB DIFFERENCE: %f', message, max(abs(d(:))));
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB-ISET AGREE for XYZ to linear sRGB (tolerance: %g)', tolerance);
    end
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.ptbSRGBPrimary = ptbSRGBPrimary;
    validationDataToSave.isetSRGBPrimary = isetSRGBPrimary;
    
    
    % ISET/PTB sRGB comparison in integer gamma corrected space
    if (any(abs(round(isetSRGBs*255)-ptbSRGBs) > tolerance))
        message = sprintf('\n\t\tPTB-ISET DIFFERENCE for XYZ to sRGB (tolerance: %g)', tolerance);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB-ISET AGREE for XYZ to sRGB (tolerance: %g)', tolerance);
    end
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.isetSRGBs = isetSRGBs*255;
    validationDataToSave.ptbSRGBs = ptbSRGBs;
    
    
    % lrgb -> srgb -> lrgb in ISET
    isetSRGBPrimaryCheckImage = srgb2lrgb(isetSRGBImage);
    isetSRGBPrimaryCheck = ImageToCalFormat(isetSRGBPrimaryCheckImage);
    if (any(abs(isetSRGBPrimaryCheck-isetSRGBPrimary) > 1e-10))
        message = sprintf('\n\t\tISET FAILS linear sRGB to sRGB to linear sRGB (tolerance: %g)', tolerance);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tISET PASSES linear sRGB to sRGB to linear sRGB (tolerance: %g)', tolerance);
    end
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.isetSRGBPrimaryCheck = isetSRGBPrimaryCheck;
    validationDataToSave.isetSRGBPrimary = isetSRGBPrimary;
    

    %% Quanta/Energy
    %
    % The ISET routines define c and h to more places than the PTB, so the
    % agreement is only good to about 5 significant places.  Seems OK to me.
    message = sprintf('\n\n\t\t***** Energy/Quanta *****');
    validationReport = sprintf('%s %s', validationReport, message);
 
    load spd_D65
    spdEnergyTest = spd_D65;
    wlsTest = SToWls(S_D65);
    testPlaces = 5;
    ptbQuanta = EnergyToQuanta(wlsTest,spdEnergyTest);
    isetQuanta = Energy2Quanta(wlsTest,spdEnergyTest);
    toleranceQuanta = (10^-testPlaces)*min(ptbQuanta);
    if (any(abs(ptbQuanta-isetQuanta) > toleranceQuanta))
        message = sprintf('\n\t\tPTB-ISET DIFFERENCE for energy to quanta conversion at %d significant places (tolerance: %g)',testPlaces, toleranceQuanta);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB-ISET AGREE for energy to quanta conversion to %d significant places (tolerance: %g)',testPlaces,  toleranceQuanta);
    end
    
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.ptbQuanta = ptbQuanta;
    validationDataToSave.isetQuanta = isetQuanta;
    
    
    if (any(abs(QuantaToEnergy(wlsTest,ptbQuanta)-spdEnergyTest) > tolerance))
        message = sprintf('\n\t\tPTB FAILS energy to quanta to energy (tolerance: %g)', tolerance);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB PASSES energy to quanta to energy (tolerance: %g)', tolerance);
    end
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.ptbEnergyFromQuanta = QuantaToEnergy(wlsTest,ptbQuanta);
    validationDataToSave.spdEnergyTest = spdEnergyTest;
    
    if (any(abs(Quanta2Energy(wlsTest,isetQuanta')'- spdEnergyTest) > tolerance))
        message = sprintf('\n\t\tISET FAILS energy to quanta to energy (tolerance: %g)', tolerance);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tISET PASSES energy to quanta to energy (tolerance: %g)', tolerance);
    end
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.isetEnergyFromQuanta = Quanta2Energy(wlsTest,isetQuanta')';
    

    %% CIE daylights
    % 
    % These routines are now running in ISET and everything agrees.
    message = sprintf('\n\n\t\t***** Energy/Quanta *****');
    validationReport = sprintf('%s %s', validationReport, message);
    
    load B_cieday
    testWls = SToWls(S_cieday);
    testTemp = 4987;
    ptbDaySpd = GenerateCIEDay(testTemp,B_cieday);
    ptbDaySpd = ptbDaySpd/max(ptbDaySpd(:));

    % Iset version of normalized daylight
    isetDaySpd = daylight(testWls,testTemp);
    isetDaySpd = isetDaySpd/max(isetDaySpd(:));
    if (any(abs(isetDaySpd-ptbDaySpd) > tolerance))
        message = sprintf('\n\t\tPTB-ISET DIFFERENCE for daylight (tolerance: %g)', tolerance);
        validationFailedFlag = true;
    else
        message = sprintf('\n\t\tPTB-ISET AGREE for for daylight (tolerance: %g)', tolerance);
    end
    % update validation report and validationDataToSave struct
    validationReport = sprintf('%s %s', validationReport, message);
    validationDataToSave.isetDaySpd = isetDaySpd;
    validationDataToSave.ptbDaySpd  = ptbDaySpd;
    

    % Generate plots, if so specified
    if (nargin >= 1) && (isfield(runParams, 'generatePlots')) && (runParams.generatePlots == true)
        % Your plotting code goes here.
    end
    
end

##### SOURCE END #####
--></body></html>