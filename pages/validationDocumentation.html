<!DOCTYPE html>
<html>

<head>
<meta charset='utf-8'>
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
<link rel="stylesheet" type="text/css" media="screen" href="../stylesheets/stylesheet.css">


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

/* add smoothscroll.js javascript */
<script type="text/javascript" src="../javascripts/smoothscroll.js"></script>


<!-- CUSTOM style classes -->
<style type="text/css">
<!--
.tab { margin-left: 20px; }

.magentaSystem {font-family:menlo; color:#ff4477;}

.myBlueCode {font-family:menlo; font-size:15px; color:#4444bb;}

.myBlackCode {font-family:menlo; font-size:15px}

.mySmallBlackCode {font-family:menlo; font-size:13px}

pre {
    display: block;
    font-family: menlo;
    font-size:14px;
    white-space: pre;
    margin: 1em 0;
}

.TFtable{
		width:100; 
		border-collapse:collapse; 
}

.TFtable td{ 
		padding:2px; border:#4e95f4 1px solid;
}

.TFtable tr{
		background: #b8d1f3;
}

/*  Define the background color for all the ODD background rows  */
.TFtable tr:nth-child(odd){ 
		background: #dddddd; 
}

/*  Define the background color for all the EVEN background rows  */
.TFtable tr:nth-child(even){
		background: #eeeeee;
}

.navbar  {
   background:rgba(0,0,0,0.5);   /* for latest browsers */
}

.nav-collapse  {
   background:rgba(0,0,0,1.0);   /* for latest browsers */
}

.navbar-default {
    background-color: #f8F8F8;
    border-color: #E7E7E7;
}

.navbar{ 
    background-image: none;
}

-->


</style>

<title>isetbioValidation</title>
</head>

<body>

<!-- HEADER -->
<div id="header_wrap" class="outer">
    <header class="inner">
      <h1 id="project_title">isetbio: script validation</h1>
      <h2 id="project_tagline">documentation and usage of the @UnitTest class</h2>
    </header>
</div>


    
<!-- MAIN CONTENT -->
<div id="main_content_wrap" class="outer">
  <section id="main_content" class="inner">
  

 <!-- --------  -->  
 <!--  Navigation bar --> 
 <!-- --------  --> 
 
 <nav id="navigationBar" role="navigation" class="nav-collapse navbar-default navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" data-target="#navbarCollapse" data-toggle="collapse" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>
        <!-- Collection of nav links and other content for toggling -->
        <div id="navbarCollapse" class="navbar-collapse">
            <ul class="nav navbar-nav">
                <li><a href="#overview" class="smoothScroll">overview</a></li>
                <li class="dropdown">
	                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
	                data validation <b class="caret"></b>
	               </a>
		            <ul class="dropdown-menu">
		               <li><a href="#external validation" class="smoothScroll">external validation</a></li>
		               <li><a href="#internal validation" class="smoothScroll">internal validation</a></li>
		            </ul>
                </li>
                <li class="dropdown">
	                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
	                @UnitTest usage patterns <b class="caret"></b>
	               </a>
		            <ul class="dropdown-menu">
		               <li><a href="#@UnitTest usage patterns-basic" class="smoothScroll">basic validation</a></li>
		               <li><a href="#@UnitTest usage patterns-tuning" class="smoothScroll">tuning the validation</a></li>
		            </ul>
                </li>
        		<li><a href="#Writing @UnitTest - enabled scripts" class="smoothScroll">writing @UnitTest - enabled scripts</a></li>
            </ul>
        </div>
    </div>
</nav>




 <!-- --------  -->  
 <!-- OVERVIEW  --> 
 <!-- --------  --> 

    
<h2>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"></a>overview
</h2>


<p>This document describes how to use the custom @UnitTest class for validating isetbio scripts. The class executes isetbio scripts and manages the data generated by these scripts so as to conduct different levels of validation. Starting at the most basic (and fastest) level, the available <font color="#ff4477"> validation modes</font> are:
<ul>
  <li><b class="magentaSystem">'RUNTIME_ERRORS_ONLY'</b>:  only checking for run-time exceptions.</li>
  <li><b class="magentaSystem">'FAST'</b>: run-time exceptions + SHA-256 signature validation of select data.</li>
  <li><b class="magentaSystem">'FULL'</b>: run-time exceptions + numerical validation of select data.</li>
  <li><b class="magentaSystem">'PUBLISH'</b>: run-time exceptions + numerical validation + publication to <a href="https://github.com/isetbio/isetbio/wiki/ValidationResults">github site</a>.</li>
</ul>

<p>
The <b class="magentaSystem">'RUNTIME_ERRORS_ONLY'</b> validation mode is the quickest and may be useful to ensure the basic integrity of isetbio core methods, for example that calls to isetbio functions do not crash. 

<p>The <b class="magentaSystem">'FAST'</b> validation mode can be used to check that data generated by isetbio scripts agree across different versions of isetbio and/or across different machines/operating systems.

<p>If any data inconsistencies are detected, the <b class="magentaSystem">'FULL'</b> validation run would be useful to identify the data fields whose values have changed and to provide quantitative descriptions of any differences. 

<p>Finally, the <b class="magentaSystem">'PUBLISH'</b> validation mode is useful as it generates published reports of isetbio code with plots of thegenerated data, in addition to full data validation. These reports which are published <a href="https://github.com/isetbio/isetbio/wiki/ValidationResults">on isetbio's github site</a>, can serve as tutorials for the various functionalities of isetbio.


 <!-- --------------------  -->  
 <!-- VALIDATION OPERATIONS --> 
 <!-- --------------------  --> 
 

<h2>
    <a id="external validation" class="anchor" href="#data validation: external2" aria-hidden="true"> </a> data validation: external operations
</h2>
The @UnitTest class provides methods that enable a validation script to select specific data for inclusion to a validation dataset that corresponds to that script. The first time that a validation script is run, the generated validation dataset becomes the 'ground truth' for this script. In subsequent runs, methods of the @UnitTest class compare the generated dataset to the corresponding 'ground truth' dataset to establish whether the current run produces data that are consistent with the 'ground truth'. User-settable preferences in @UnitTest allow a validation dataset to be added to the history of validation datasets and/or ground truth data sets.
 
<p class="tab"><strong> 'FAST' validation mode: </strong>
In 'FAST' validations, all numerical fields of the validation dataset are truncated to 12 decimal digits, and a SHA-256 hash key is generated based on the truncated data set. A validation script passes 'FAST' validation, if the hash key matches exactly the hash key stored in the ground truth dataset. We have found that data truncation to 12 decimal digits generate hash keys that match across different computers (three Mac dekstops and one laptop, all running OSX), whereas truncation to 13 or more decimal digits generate hash keys that do not match across these computers. We do not know the situation about Windows/Linux computers yet.

<p>
<p class="tab"><strong> 'FULL' validation mode: </strong>In 'FULL' validations, all corresponding fields of the validation and ground truth data sets are compared numerically. A validation script passes 'FULL' data validation if the absolute differences between the corresponding fields in the two datasets do not exceed a numerical threshold, which is determinted by a user-setable @UnitTest preference.

<h2>
    <a id="internal validation" class="anchor" href="#data validation internal" aria-hidden="true"></a>  data validation: internal operations
</h2>
The @UnitTest class also provides methods that allow additional validations which are based on internal (to the script) consistency checks specified within the validation script itself. For example, a validation script may check the agreement between the result generated by an isetbio computation and the result generated by other means, for example psychtoolbox computations. If the agreement is not satisfactory, the validation script can use @UnitTest class methods to declare that it has failed to pass validation.
<br>
<br>

 <!-- ------------------------------------  -->  
 <!-- @UNIT_TEST USAGE PATTERNS:BASIC USAGE --> 
 <!-- ------------------------------------  --> 
 

<h2>
    <a id="@UnitTest usage patterns-basic" class="anchor" href="#@UnitTest usage patterns-basic" aria-hidden="true"></a> @UnitTest usage: basic validation
</h2>

A validation session can be conducted by calling:
<br>
<p class="tab">
<b class="myBlueCode">UnitTest.runValidationSession(vScriptsList, <b class="magentaSystem">validationMode</b>);</b>
</p>

where <b class="myBlackCode">vScriptsList</b> is a cell array containing the names of individual validation scripts or the names of directories containing validation scripts, and <b class="magentaSystem">validationMode</b> is one of the four validation modes discussed. If a <b class="magentaSystem">validationMode</b> variable is not passed, the user will be asked to provide one.
<br>
<br>
<strong> Example 1: </strong> conduct a 'FAST' validation of scripts <b class="myBlackCode">'v_Colorimetry.m', 'v_IrradianceIsomerizations.m'</b>
<pre>
<b class="myBlueCode">
vScriptsList = {...
   {'v_Colorimetry'} ...
   {'v_IrradianceIsomerizations'} ...
};

UnitTest.runValidationSession(vScriptsList, <b class="magentaSystem">'FAST'</b>);
</b>
</pre>
<br>
<strong> Example 2: </strong> conduct a 'FULL' validation of all scripts contained in directories <b class="myBlackCode"> 'validationScripts/color', 'validationScripts/cones', 'validationScripts/human', and 'validationScripts/radiometry'</b>.
<pre>
<b class="myBlueCode">
vScriptsList = {...
  {'validationScripts/color'} ...
  {'validationScripts/cones'} ...
  {'validationScripts/human'} ...
  {'validationScripts/radiometry'} ...
};

UnitTest.runValidationSession(vScriptsList,  <b class="magentaSystem">'FULL'</b>);
</b>
</pre>
<br>
<br>

 <!-- ------------------------------------  -->  
 <!-- @UNIT_TEST USAGE PATTERNS:BASIC USAGE --> 
 <!-- ------------------------------------  --> 
 
 
<h2>
<a id="@UnitTest usage patterns-tuning" class="anchor" href="#@UnitTest usage patterns-tuning" aria-hidden="true"></a>  @UnitTest usage: tuning the validation
</h2>

The user can fine tune how validation runs are performed by setting various @UnitTest preferences. The available @UnitTest preferences and their current values can be obtained by the following call:
<br>
<p class="tab">
<b class="myBlueCode">UnitTest.listPrefs();</b>
</p>
which, at the time that this document was last updated, produced the following output:
<pre>
Current isetbioValidation prefs:
 'updateGroundTruth'            with value: false
 'updateValidationHistory'      with value: false
 'onRunTimeErrorBehavior'       with value: 'rethrowExceptionAndAbort'
 'generatePlots'                with value: false
 'closeFigsOnInit'              with value: true
 'verbosity'                    with value: 'low'
 'numericTolerance'             with value: 1.11022e-13
 'graphMismatchedData'          with value: true
 'validationRootDir'            with value: '/Users/Shared/Matlab/Toolboxes/ISETBIO/validation'
 'clonedWikiLocation'           with value: '/Users/Shared/Matlab/Toolboxes/ISETBIO_Wiki/isetbio.wiki'
 'clonedGhPagesLocation'        with value: '/Users/Shared/Matlab/Toolboxes/ISETBIO_GhPages/isetbio'
 'githubRepoURL'                with value: 'http://isetbio.github.io/isetbio'
</pre>


<br>
The following table provides some information about how the @UnitTest object reacts according to the value of different preferences.
<table class="TFtable">
	
	<tr><td><b class="mySmallBlackCode">'updateGroundTruth' <br> <em> true/false </em></b></td><td>if set to true, the @UnitTest object will append the current validation data to the history of ground truth data sets.</td></tr>
	
	<tr><td><b class="mySmallBlackCode">'updateValidationHistory' <br> <em> true/false </em></b></td><td>if set to true, the @UnitTest object will append the current validation data to the history of validation data sets. </td></tr>	
	
	<tr><td><b class="mySmallBlackCode">'onRunTimeErrorBehavior' <br> <em>'catchExceptionAndContinue' 'rethrowExceptionAndAbort' </em></b></td><td> if set to 'catchExceptionAndContinue', and a validation script raises an exception at run time, the @UnitTest object will allow the validation session to continue with the remaining scripts, otherwise it will terminate it.</td></tr>
	
	<tr><td><b class="mySmallBlackCode">'generatePlots' <br> <em> true/false </em></b></td><td>if set to true, validation scripts are allowed to generate plots. For 'FAST' or 'RUN_TIME_ERRORS_ONLY' validation runs this is usually set to false.</td></tr>
	
	<tr><td><b class="mySmallBlackCode">'closeFigsOnInit' <br> <em> true/false </em></b></td><td>if set to true, the @UnitTest object will close all existing figs generated by previous scripts during the initialization phase of the current script. </td></tr>
	
	<tr><td><b class="mySmallBlackCode">'verbosity' <br>  <em>'none', 'min', 'low', 'med', 'high', 'max' </em> </b></td><td>determines how much information is sent to the command window by the the @UnitTest object. </td></tr>
	
	<tr><td><b class="mySmallBlackCode">'numericTolerance' <em> a multiple of EPS (usually 500*EPS)</em></b></td><td>determines the minimal difference in numerical value between validation and ground truth data in order for the @UnitTest object to trigger a failed validation flag. </td></tr>
	
	<tr><td><b class="mySmallBlackCode">'graphMismatchedData', <em> true/false </em></b></td><td>if set to true, and a validation field differs from its corresponding ground truth field by more than the set 'numericTolerance', the @UnitTest object will generate plots of the validation data, the ground truth data, and their difference.</td></tr>
	
	<tr><td><b class="mySmallBlackCode">'validationRootDir' <br> <em>absolute path of the folder under which validation script directories live </em></b></td><td>set according to your local machine configuration</td></tr>
	
	<tr><td><b class="mySmallBlackCode">'clonedWikiLocation' <br> <em> absolute path of the folder under which the isetbio.wiki is cloned.</em> </b></td><td>set according to your local machine configuration (relevant only during sessions in 'PUBLISH' validation mode). </td></tr>

	<tr><td><b class="mySmallBlackCode">'clonedGhPagesLocation' <br> <em> absolute path of the folder under which the 'gh-pages' branch of isetbio is cloned. </em></b></td><td>set according to your local machine configuration (relevant only during sessions in 'PUBLISH' validation mode). </td></tr>

	<tr><td><b class="mySmallBlackCode">'githubRepoURL', <br> <em> URL of isetbio githug repository. </em></b></td><td>set according to your local machine configuration (relevant only during sessions in 'PUBLISH' validation mode). </td></tr>

</table>
<br>
The user can change any of these above preferences by the following call:
<br>
<p class="tab">
<b class="myBlueCode">UnitTest.setPref(preferenceName, preferenceValue);</b>
</p>

<br>
<strong> Example: </strong> First reset all isetbio validation preferences to their default values, then change some of them.
<pre>
<b class="myBlueCode">
 %% Initialize ISETBIO preferences
 UnitTest.initializePrefs();
    
 %% Optionally, reset ISETBIO prefs to the default values
 UnitTest.initializePrefs('reset');
    
 %% Change some preferences
 % Update the validation data history, 
 % for example to include data from different machines
 UnitTest.setPref('updateValidationHistory', true);
  
 % Run time error behavior
 UnitTest.setPref('onRunTimeErrorBehavior','catchExceptionAndContinue');
    
 % Generate plots
 UnitTest.setPref('generatePlots',  true); 
 UnitTest.setPref('closeFigsOnInit', true);
    
 % Verbosity level to medium
 UnitTest.setPref('verbosity', 'med');
    
 % Numeric tolerance for comparison to ground truth data
 UnitTest.setPref('numericTolerance', 500*eps);
    
 % Do not plot data that do not agree with the ground truth
 UnitTest.setPref('graphMismatchedData', false);
</b>
</pre>
<br>
The <b class="myBlueCode">validationDemo.m</b> executive script provides a template for running a validation session. The user should adapt this template to generate executive validation session scripts for different purposes.
<br>
<br>
<br>

 
<h2>
<a id="Writing @UnitTest - enabled scripts" class="anchor" href="Writing @UnitTest - enabled scripts" aria-hidden="true"></a>writing @UnitTest - enabled scripts
</h2>

This section describes how to transform a regular isetbio script to a @UnitTest-enabled validation script.



</body>
</html>
