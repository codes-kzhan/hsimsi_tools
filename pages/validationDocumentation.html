<!DOCTYPE html>
<html>
    
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>ISETBIO VALIDATION</title>
        <meta name="description" content="An interactive getting started guide for Brackets.">
        
        <!-- STYLE FOR NAVIGATION BAR -->
        <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css"> -->
        <link rel="stylesheet" href="../stylesheets/bootstrap/3.3.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="../stylesheets/bootstrap/3.3.1/css/bootstrap-theme.min.css">
        
        <!-- STYLE SPECIFIC TO THIS PAGE -->
        <link rel="stylesheet" href="main.css">
        
        <!-- javascripts for navbar -->
        <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script> -->
        <script type="text/javascript" src="../javascripts/jquery/1.11.1/jquery.min.js"></script>
        
        <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script> -->
        <script type="text/javascript" src="../javascripts/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        
        <!-- add javascript for smooth scrolling   -->
        <script type="text/javascript" src="../javascripts/smoothscroll.js"></script>
        
    </head>
    
    
    <body>    
        <h1>isetbio: script validation</h1>
        <h2>documentation and usage of the @UnitTest class</h2>
        
        <!--
            NAVIGATION BAR ON TOP
        -->
        <nav id="navigationBar" role="navigation" class="nav-collapse navbar-default navbar-fixed-top">
            <div class="container-fluid">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <button type="button" data-target="#navbarCollapse" data-toggle="collapse" class="navbar-toggle">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>
                
                <!-- Collection of nav links and other content for toggling -->
                <div id="navbarCollapse" class="navbar-collapse">
                    <ul class="nav navbar-nav">
                        
                        <!-- First menu item -->
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                validation approach <b class="caret"></b>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a href="#overview" class="smoothScroll"> overview </a></li>
                                <li><a href="#data validation" class="smoothScroll"> data validation</a></li>
                                <li><a href="#data validation:external" class="smoothScroll"> external data validations </a></li>
                                <li><a href="#data validation:internal" class="smoothScroll"> internal data validations</a></li>
                            </ul>
                        </li>
                        
                        <!-- Second menu item -->
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                conducting validation sessions <b class="caret"></b>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a href="#basic validation sessions" class="smoothScroll"> basic validation sessions</a></li>
                                <li><a href="#customizing validation sessions" class="smoothScroll"> designing custom validation sessions</a></li>
                            </ul>
                        </li>
                        
                        <!-- Third menu item -->
                        <li>
                            <a href="#writing validation scripts" class="smoothScroll">
                            writing validation scripts
                            </a>
                        </li>
                        
                        <!-- Fourth menu item -->
                        <li>
                            <a href="#end" class="smoothScroll">
                            end
                            </a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </nav>
        
        <!--
            OVERVIEW
        -->
        
        
        <h7> 
            <a id="overview" href="#overview"></a> <hr>
        </h7>
        <h3>
           Overview
        </h3>
        
        <p>
             This document describes the capabilities and usage of the custom @UnitTest class for validating isetbio scripts. The class executes isetbio scripts, checks for runtime errors, manages data generated by these scripts, validates select data against a ground truth dataset, produces published reports of the isetbio code and the resulting output, and pushes these reports onto isetbio's wiki for use as isetbio tutorials. 
        </p>
        
        <p>
            In the @UnitTest-based validation framework, an executive script defines a <strong> validation session</strong> and instantiates a @UnitTest object to manage that validation session. A validation session is specified by 
           <ul>
               <li> a list of validation scripts, </li>
               <li> a validation mode and, </li>
               <li> a set of optional validation preferences, for fine tuning the validation.</li>
           </ul>
        </p>
    
        <p>
           There are four types of validation modes.
        </p>
        
        <p>
        <ul>
            <li><magenta> 'RUNTIME_ERRORS_ONLY'</magenta>,  only checking for run-time exceptions during script execution.</li>
            <li><magenta> 'FAST' </magenta>, checking for run-time exceptions + SHA-256 signature validation of select data.</li>
            <li><magenta>'FULL' </magenta>, checking for run-time exceptions + numerical validation of select data.</li>
            <li><magenta>'PUBLISH'</magenta>, checking for run-time exceptions + numerical validation + publication to <a href="https://github.com/isetbio/isetbio/wiki/ValidationResults">github site.</a></li>
        </ul>
        </p>
    
        <p> 
            The <magenta>'RUNTIME_ERRORS_ONLY'</magenta> validation mode is the quickest and may be useful to check the basic integrity of isetbio core methods, for example that calls to them do not crash. 
        </p>

        <p> 
            The <magenta> 'FAST'</magenta> validation mode can be used to check that data generated by isetbio scripts agree across different versions of isetbio and/or across different machines/operating systems.
        </p>

        <p>
            If any data inconsistencies are detected during a <magenta>'FAST'</magenta> validation, the <magenta>'FULL'</magenta> validation mode is useful to identify the data fields whose values have changed from the ground truth and to provide quantitative descriptions of any differences. 
        </p>

        <p> 
            Finally, the <magenta>'PUBLISH'</magenta> validation mode is useful as it generates published reports of isetbio code with plots of thegenerated data, in addition to full data validation. These reports which are published <a href="https://github.com/isetbio/isetbio/wiki/ValidationResults">on isetbio's github site</a>, can serve as tutorials for the various functionalities of isetbio.
        </p>
        
        <h7> 
            <a id="data validation" href="#data validation"></a> <hr>
        </h7>
        <h3>
           Data validation
        </h3>
        
        <p>
        For all validation modes other than <magenta>'RUNTIME_ERRORS_ONLY'</magenta>, the @UnitTest object enables two methods of data validation: external checks, in which data generated by validation scripts are contrasted to corresponding data in a ground truth dataset, and internal checks, in which validation scripts report their own validation status based on assessments conducted within the scripts themselves.  
        </p>

        <!--
            Data validation: external checks
        -->
        <h7> 
            <a id="data validation:external" href="#data validation:external"></a> <hr>
        </h7>
        <h3>
           External data validations
        </h3>
        
        <p>
            The @UnitTest class provides methods that enable validation scripts to select which data are to be included in their the validation dataset. The first time that a validation script is executed by a @UnitTest object, the generated validation dataset becomes the <strong>ground truth </strong> for this script. In subsequent runs, methods of the @UnitTest class compare the generated dataset to the corresponding ground truth dataset and establish whether the current run produces data that are consistent with the ground truth. 
        </p>
        
        <p>
            The type of comparison between validation and ground truth data sets is determined by the selected <magenta> validation mode</magenta>.
        </p>
        
        <p class="tab">
        In <magenta> 'FAST'</magenta> validations, all numerical fields of the validation dataset are truncated to 12 decimal digits, and a SHA-256 hash key is generated based on the truncated data set. A validation script passes <magenta> 'FAST'</magenta> validation, if the hash key matches exactly the hash key stored in the ground truth dataset. We have found that data truncation to 12 decimal digits generate hash keys that match across different computers (three Mac dekstops and one laptop, all running OSX), whereas truncation to 13 or more decimal digits generate hash keys that do not match across these computers. We do not know the situation about Windows/Linux computers yet.
        </p>
        
        <p class="tab">
            In <magenta> 'FULL'</magenta> and <magenta> 'PUBLISH'</magenta> validations, all corresponding fields of the validation and ground truth data sets are compared. A validation script passes these validation modes, if the absolute differences between corresponding fields in the two datasets do not exceed a numerical threshold, which is determined by a user-adjustable @UnitTest preference.
        </p>
        
        <!--
            Data validation: internal checks
        -->
        <h7> 
            <a id="data validation:internal" href="#data validation:internal"></a> <hr>
        </h7>
        <h3>
          Internal data validations
        </h3>
        
        <p>
        The @UnitTest class also provides methods that allow a script to report whether it has pass any internal validation checks, based on consistency checks conducted within the validation script itself. For example, a validation script may check the agreement between results generated by isetbio computations and results generated by other means, for example psychtoolbox computations. If the agreement is not satisfactory, the validation script can convey to the @UnitTest object that it has failed to pass its internal checks.
        </p>
        
        
        <h7> 
            <a id="basic validation sessions" href="#basic validation sessions"></a> <hr>
        </h7>
        <h3>
           Basic validation sessions
        </h3>
        

        <p>
             A basic validation session is conducted by calling the following @UnitTest class method: 
            <p class="tab">
                <blackCode>UnitTest.runValidationSession(<blueCode>vScriptsList</blueCode>, <magenta>validationMode</magenta>);</blackCode>
            </p>
            where <blueCode>vScriptsList</blueCode> is a cell array containing the names of individual validation scripts or the names of directories containing validation scripts, and <magenta>validationMode</magenta> is one of the four validation modes discussed earlier. If no <magenta>validationMode</magenta> variable is passed, the user will be asked to provide one. 
        </p>

        <p>
            Examples of basic validation modes are shown below. The first example does a <magenta>FAST</magenta> validation followed by a <magenta>FULL</magenta> validation of a couple of scripts. This situation would be encountered when new validation scripts are introduced and we want to generate FAST AND FULL ground truth data sets for them.
        </p>    
<pre><greenCode>% Basic 'FULL' mode validation session of scripts 
% v_Colorimetry.m and v_IrradianceIsomerizations.m 
</greenCode>
<blueCode>vScriptsList</blueCode> = {...
  {'v_Colorimetry'} ...
  {'v_IrradianceIsomerizations'} ...
};

UnitTest.runValidationSession(<blueCode>vScriptsList</blueCode>, <magenta>'FAST'</magenta>);
UnitTest.runValidationSession(<blueCode>vScriptsList</blueCode>, <magenta>'FULL'</magenta>);
</pre>

        <p> The second example does a <magenta>RUN_TIME_ERRORS_ONLY</magenta> validation of a number of all scripts located in four different directories. This situation would be encountered when some basic core functionality in isetbio was changed and we want to quickly assert whether this change breaks fundamental isetbio operations.
        </p> 
<pre><greenCode>% Basic 'RUN_TIME_ERRORS_ONLY' mode validation session of all scripts in directories
% validationScripts/scene 
% validationScripts/opticalImage
% validationScripts/sensor
% validationScripts/radiometry
</greenCode>
<blueCode>vScriptsList</blueCode> = {...
  {'validationScripts/scene'} ...
  {'validationScripts/opticalImage'} ...
  {'validationScripts/sensor'} ...
  {'validationScripts/radiometry'} ...
};

UnitTest.runValidationSession(<blueCode>vScriptsList</blueCode>, <magenta>'RUN_TIME_ERRORS_ONLY'</magenta>);
</pre>


        <h7> 
            <a id="customizing validation sessions" href="#customizing validation sessions"></a> <hr>
        </h7>
        <h3>
           Designing custom validation sessions
        </h3>

        <p>
            The @UnitTest class provides several preferences that the user can adjust in order to customize how validations are performed. The available preferences and their current values can be obtained by the following call:
            <p class="tab">
                <blackCode>UnitTest.listPrefs();</blackCode>
            </p>
            which, at the time that this document was last updated, produced the following output:
<pre>
Current isetbioValidation prefs:
<strong>'updateGroundTruth'</strong>      : <em>false</em>
<strong>'updateValidationHistory'</strong>: <em>false</em>
<strong>'onRunTimeErrorBehavior'</strong> : <em>'rethrowExceptionAndAbort'</em>
<strong>'generatePlots'</strong>          : <em>false</em>
<strong>'closeFigsOnInit'</strong>        : <em>true</em>
<strong>'verbosity'</strong>              : <em>'low'</em>
<strong>'numericTolerance'</strong>       : <em>1.11022e-13</em>
<strong>'graphMismatchedData'</strong>    : <em>true</em>
<strong>'validationRootDir'</strong>      : <em>'/Users/Shared/Matlab/Toolboxes/ISETBIO/validation'</em>
<strong>'clonedWikiLocation'</strong>     : <em>'/Users/Shared/Matlab/Toolboxes/ISETBIO_Wiki/isetbio.wiki'</em>
<strong>'clonedGhPagesLocation'</strong>  : <em>'/Users/Shared/Matlab/Toolboxes/ISETBIO_GhPages/isetbio'</em>
<strong>'githubRepoURL'</strong>          : <em>'http://isetbio.github.io/isetbio'</em>
</pre>
        </p>
        
        <p>
            The functionality and possible values of these preferences are summarized below.
            <table class="TFtable">
                <tr>
                    <td>
                        <smallBlackCode><strong>'updateGroundTruth'</strong> </smallBlackCode>
                        <br> 
                        <lightBlueCode> true/false </lightBlueCode>
                    </td>
                    <td>
                        if set to true, the @UnitTest object will append the current validation data to the history of ground truth data sets.
                    </td>
                </tr>
	
                <tr>
                    <td>
                        <smallBlackCode><strong>'updateValidationHistory'</strong> </smallBlackCode>
                        <br> 
                        <lightBlueCode> true/false </lightBlueCode>
                    </td>
                    <td>
                        if set to true, the @UnitTest object will append the current validation data to the history of validation  data sets.
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <smallBlackCode><strong>'onRunTimeErrorBehavior'</strong> </smallBlackCode>
                        <br> 
                        <lightBlueCode>
                        'catchExceptionAndContinue' 'rethrowExceptionAndAbort'
                        </lightBlueCode>
                    </td>
                    <td>
                        if set to <lightBlueCode>'catchExceptionAndContinue'</lightBlueCode>, and a validation script raises an exception at run time, the @UnitTest object will allow the validation session to continue with the remaining scripts, otherwise it will terminate it.
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <smallBlackCode><strong>'generatePlots'</strong> </smallBlackCode>
                        <br> 
                        <lightBlueCode> true/false </lightBlueCode>
                    </td>
                    <td>
                        if set to true, validation scripts are allowed to generate plots. For 'FAST' or 'RUN_TIME_ERRORS_ONLY' validation runs this would usually set to false.
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <smallBlackCode><strong>'closeFigsOnInit'</strong> </smallBlackCode>
                        <br> 
                        <lightBlueCode> true/false </lightBlueCode>
                    </td>
                    <td>
                        if set to true, the @UnitTest object will close any existing figures generated by previous scripts during the initialization phase of the current script.
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <smallBlackCode><strong>'verbosity'</strong> </smallBlackCode>
                        <br> 
                        <lightBlueCode> 'none', 'min', 'low', 'med', 'high', 'max' </lightBlueCode>
                    </td>
                    <td>
                        determines how much information is sent to the command window by the the @UnitTest object. 
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <smallBlackCode><strong>'numericTolerance'</strong> </smallBlackCode>
                        <br> 
                        <lightBlueCode> multiple of EPS (usually 500*EPS) </lightBlueCode>
                    </td>
                    <td>
                        determines the minimal difference in numerical value between validation and ground truth data in order for the @UnitTest object to trigger a validation FAILED flag.  
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <smallBlackCode><strong>'graphMismatchedData'</strong> </smallBlackCode>
                        <br> 
                        <lightBlueCode> true/false </lightBlueCode>
                    </td>
                    <td>
                        if set to true, the value of a validation field differs from its corresponding ground truth value by more than the set 'numericTolerance', the @UnitTest object will generate plots of the validation data, the ground truth data, and their difference. Applies only to 'FULL' and 'PUBLISH' validation modes.
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <smallBlackCode><strong>'validationRootDir'</strong> </smallBlackCode>
                        <br> 
                        <lightBlueCode> absolute path of the folder under which validation script directories live  </lightBlueCode>
                    </td>
                    <td>
                        must be set according to the user's local machine configuration.
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <smallBlackCode><strong>'clonedWikiLocation'</strong> </smallBlackCode>
                        <br> 
                        <lightBlueCode> absolute path of the folder under which the isetbio.wiki is cloned </lightBlueCode>
                    </td>
                    <td>
                        must be set according to the user's local machine configuration. Applies only to 'PUBLISH' validation mode.
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <smallBlackCode><strong>'clonedGhPagesLocation'</strong> </smallBlackCode>
                        <br> 
                        <lightBlueCode> absolute path of the folder under which the 'gh-pages' branch of isetbio is cloned </lightBlueCode>
                    </td>
                    <td>
                        must be set according to the user's local machine configuration. Applies only to 'PUBLISH' validation mode.
                    </td>
                </tr>
                
                <tr>
                    <td>
                        <smallBlackCode><strong>'githubRepoURL'</strong> </smallBlackCode>
                        <br> 
                        <lightBlueCode> github URL of isetbio </lightBlueCode>
                    </td>
                    <td>
                       currently: 'http://isetbio.github.io/isetbio'
                    </td>
                </tr>
            </table>
        </p>
        
        <p>
            The user can change any of these preferences by the following call:
            <p class="tab">
                <blackCode>UnitTest.setPref(preferenceName, preferenceValue);</blackCode>
            </p>
            thus, designing customized validation sessions for different purposes. The following code shows an example of customizing a 'FULL' validation session.
        </p> 

<pre><greenCode>% Executive script for customized validation</greenCode>
function validateDemo

<greenCode> % Initialize @UnitTest preferences</greenCode>
 UnitTest.initializePrefs();
    
<greenCode> % Optionally, reset prefs to the default values </greenCode>
 UnitTest.initializePrefs('reset');
    
<greenCode> % Change some preferences:</greenCode>
<greenCode> % Update the histories of validation data sets</greenCode>
 UnitTest.setPref('updateValidationHistory', true);
 UnitTest.setPref('updateGroundTruth', false);

<greenCode> % Run time error behavior </greenCode>
 UnitTest.setPref('onRunTimeErrorBehavior', 'rethrowExceptionAndAbort');

<greenCode> % Plot generation </greenCode>
 UnitTest.setPref('generatePlots',  true); 
 UnitTest.setPref('closeFigsOnInit', true);

<greenCode> % Give me some info </greenCode>
 UnitTest.setPref('verbosity', 'med');

<greenCode> % Numeric tolerance for comparison to ground truth data </greenCode>
 UnitTest.setPref('numericTolerance', 500*eps);
    
<greenCode> % Whether to plot data that do not agree with the ground truth </greenCode>
 UnitTest.setPref('graphMismatchedData', false);

<greenCode> % Print current values of isetbioValidation prefs</greenCode>
 UnitTest.listPrefs();

<greenCode>% What to validate </greenCode>
 <blueCode>vScriptsList</blueCode> = {...
  {'validationScripts/scene'} ...
  {'validationScripts/opticalImage'} ...
  {'validationScripts/sensor'} ...
  {'validationScripts/radiometry'} ...
};

<greenCode> % Go !  </greenCode>
 UnitTest.runValidationSession(<blueCode>vScriptsList</blueCode>, <magenta>'FULL'</magenta>);

end
</pre>
        
        
        <h7> 
            <a id="writing validation scripts" href="#writing validation scripts"></a> <hr>
        </h7>
        <h3>
           Writing validation scripts
        </h3>

        <p>
            This section describes the structure of validation scripts suitable for management by @UnitTest. All @UnitTest-enabled validation scripts contain a wrapper function, followed by a validation function which contains the actual isetbio validation code. 
        </p>
        <p>
        	The wrapper function is identical for all validation scripts and its only purpose is to call the validation function and to communicate results generated by the validation function back to the managing @UnitTest object. The wrapper function for the 'v_IrradianceIsomerizations.m' script is displayed below.
        </p>

<pre>
<blackCode>function varargout = v_IrradianceIsomerizations(varargin)
<grayCode><greenCode>%
% Validate ISETBIO-based irradiance/isomerization computations by comparing to PTB-based irradiance/isomerization computations.
%</greenCode>

<greenCode>% Initialize validation run and return params</greenCode>
 runTimeParams = UnitTest.initializeValidationRun(varargin{:});
 if (nargout > 0) varargout = {'', false, []}; end
    
<greenCode>% Validation - Call validation script</greenCode>
<blueCode> ValidationFunction(runTimeParams); </blueCode>
    
<greenCode>%  Reporting and return params</greenCode>
 if (nargout > 0)
    [validationReport, ...
     validationFailedFlag, ...
     validationFundametalFailureFlag] = ...
                      UnitTest.validationRecord('command', 'return');
    validationData  = UnitTest.validationData('command', 'return');
    extraData       = UnitTest.extraData('command', 'return');
    varargout       = {validationReport, validationFailedFlag, ...
                       validationFundametalFailureFlag, validationData, ...
                       extraData};
 else
    if (runTimeParams.printValidationReport)
        [validationReport, ~] = UnitTest.validationRecord('command', 'return');
        UnitTest.printValidationReport(validationReport);
    end 
 end
</grayCode>end    
</blackCode>
</pre>
		<p>
			The wrapper function is named according to the isetbio functionality that is tested (irradiance isomerization computations, in this example), whereas the comment appearing in line #2 of the wrapper function is used to describe this validation script in isetbio's github wiki site.
	</p>      	
		<p>
       The <blueCode>ValidationFunction</blueCode> contains the isetbio code to be tested. Interspersed amongst the evaluated code are calls to @UnitTest methods for logging <b>data</b> and <b>messages</b> to the managing @UnitTest object. 
       </p>
       <p>
       Two types of <b>data</b> can be logged to the managing @UnitTest object: 
       	<ul>
        		<li> <strong> validation data</strong>, which are the data used during external validations and, </li>
              <li> <strong> extra data </strong>, which are additional data, not used during the validation, but are stored nevertheless in the saved ground truth history as reference data</li>
               
           </ul>
      	</p>
		This is achieved by the following calls:
		<p class="tab">
         	<blackCode>UnitTest.validationData('fieldName', fieldValue);</blackCode><br>
         	<blackCode>UnitTest.extraData('fieldName', fieldValue);</blackCode>
      	</p>
            
		<p>
       The following types of <b>messages</b> can be logged to the managing @UnitTest object: 
       	<ul>
        		<li> <b>simple messages</b> with no special status, </li>
              <li> messages indicating that a <b>fundamental internal check failed</b></li>
              <li> messages indicating that an <b>internal check failed</b></li>
				<li> messages indicating that an <b>internal check passed</b></li>
          </ul>
      	</p>
      	This is achieved by the following calls:
		<p class="tab">
		   <blackCode>UnitTest.validationRecord('SIMPLE_MESSAGE', messageString);</blackCode><br>
		   <blackCode>UnitTest.validationRecord('FUNDAMENTAL_CHECK_FAILED', messageString);</blackCode><br>
         	<blackCode>UnitTest.validationRecord('FAILED', messageString);</blackCode><br>
         	<blackCode>UnitTest.validationRecord('PASSED', messageString);</blackCode><br>
      	</p>
      	
		<p>
		The validation function for the 'v_IrradianceIsomerizations.m' script is displayed below.
		</p>
        <!--
         javascript script for collapsing the navbar on click 
        -->
        <script>
            $(document).on('click',function(){
                $('.navbar-collapse').collapse('hide');
            })
        </script>

    </body>
</html>

